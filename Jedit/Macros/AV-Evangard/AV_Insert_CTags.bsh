/*
* AV_Insert_CTags.bsh
* - a BeanShell macro script for jEdit text editor including a plain
 - Typographer's Toolkit:
* - inserts p.sfm word tags around selected text (\ then lower case letter and num keys)
* - inserts typographer's quotes (number, shift-num, puncuation keys)
* - inserts typographer's braces (bracing and slash keys)
* - inserts typographer's spaces (capital letter keys)
* - keymap can be seen at docs.google.com/spreadsheets/d/1Q8uPLzs-zCOuusRZ0Ae9XON8cXiFRpz6E090eRHkEdY
* Copyright 2017-2026 Michael Hart <avante.vangard@gmail.com>
* ---------------------------------------------------------------------------
* 95% (or more) of this  code came directly from Insert_tags.bsh 
*                Copyright (C) 2001-2010  * John Gellene , Vadim Voituk 
*               https://community.jedit.org
*
* This program is free software; you can redistribute it and/or
* modify it under the terms of the GNU General Public License
* as published by the Free Software Foundation; either version 2
* of the License, or any later version.
*
* This program is distributed in the hope that it will be useful,
* but WITHOUT ANY WARRANTY; without even the implied warranty of
* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
* See the GNU General Public License for more details.
*
* You should have received a copy of the GNU General Public License
* along with the jEdit program; if not, write to the Free Software
* Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
*
* $Id: AV_Insert_CTags.bsh
*/
// Localization
final static String EnterNameTagLabel = jEdit.getProperty("macro.rs.InsertTag.EnterNameTag.label", "Enter name of tag:");
final static String NotEditableMessage = jEdit.getProperty("macro.rs.general.ErrorNotEditableDialog.message", "Buffer is not editable"); 

// Process 
Map tagsTemplate = new TreeMap() {{
	/* Single Symbol Shifted PRE*/	
	put("~",  "`"); // U+0060 cnd NW hats
	put("!",  "‚∏Ç"); // U+2E02 cnd shell hats
	put("@",  "‚óú"); // U+25DC cnd round hats
	put("#",  "‚∏¢"); // U+2E22 cnd square hats
	put("$",  " ø"); // U+02BF cnd bowl hats
	put("%",  "‚∏ç"); // U+2E0D slash hats
	put("^",  "ÀÇ"); // U+02C2 cnd angle hats
	put("&",  "Ôπ†"); // U+FE60 small ampersand
	put("*",  "‚àó"); // U+2217 math star
	put("(",  "‚ù™"); // U+276A cnd round belts
	put(")",  "‚Åå"); // U+204C double bowl belts
	put("_",  "‚∏è"); // U+2E0F paragraphos
	put("+",  "‚Åú"); // U+205C dotted cross
	put("{",  "‚¶É"); // U+2983 double curly brackets
	put("}",  "‚ü¨"); // U+27EC double shell brackets
	put("|",  "‚èΩ"); // U+23FD cnd bar
	put(":",  "‚Åù"); // U+205D 3 dot punctuation
	put("\"",  "‚Äú"); // U+201C double curly hats
	put("<",  "¬´"); // U+00AB double angle belts
	put(">",  "‚Äπ"); // U+2039 angle belts
	put("?",  "¬ø"); // U+00BF curly dots
	/* Single Symbol PRE */	
	put("`",  "Àé"); // U+02CE cnd NW boots
	put("1",  "õ≤í"); // U+BC92 cnd shell boots
	put("2",  "‚óü"); // U+25DF cnd round boots
	put("3",  "‚∏§"); // U+2E24 cnd square boots
	put("4",  "ÍúÄ"); // U+A700 cnd double bars
	put("5",  "‚∏ú"); // U+2E1C slash boots
	put("6",  "À±"); // U+02F1 angle boots
	put("7",  "¬©"); // U+00A9 copyright
	put("8",  "¬∑"); // U+00B7 middle dot
	put("9",  "¬∂"); // U+00B6 square pilcrows
	put("0",  "‚ù°"); // U+2761 curly pilcrows
	put("-",  "‚Äë"); // U+2011 no-break dash
	put("=",  "‚ò©"); // U+2629 cross
	put("[",  "Ôπù"); // U+FE5D shell belts
	put("]",  "‚ù≤"); // U+2772 shell brackets
	put("\\",  "‚àñ"); // U+2216 math backslash
	put(";",  "‚à∑"); // U+2237 double colon
	put("\'",  "‚Äò"); // U+2018 curly hats
	put(",",  "üô∂"); // U+F676 doublecurly belts
	put(".",  "‚∏≤"); // U+2E32 curly belts
	put("/",  "·úµ"); // U+1735 condensed slash
	/* Single Shifted Alpha PRE*/	
	put("A",  "\u2E0E"); //  coronis mark <‚∏é> 
	put("B",  "\u00A0"); //  no-break space <¬†>
	put("C",  "\u2E3F"); //  capitulum <‚∏ø>
	put("D",  "\u2005"); //  mid space <‚ÄÖ>
	put("E",  "\u0083"); //  begin no-break <¬É>
	put("F",  "\u2007"); //  figure space <‚Äá>
	put("G",  "\u3000"); //  ideographic space <„ÄÄ>
	put("H",  "\u200A"); //  hair space <‚Ää>
	put("I",  "\u2063"); //  invisible comma <‚Å£>
	put("J",  "\u200D"); //  ligature joiner <‚Äç>
	put("K",  "\u2004"); //  thick space <‚ÄÑ>
	put("L",  "\u2E19"); //  palm branch <‚∏ô>
	put("M",  "\u2003"); //  mutton space <‚ÄÉ>
	put("N",  "\u2002"); //  nut space <‚ÄÇ>
	put("O",  "\u0082"); //  end no-break <¬Ç>
	put("P",  "\u2008"); //  punctuation space <‚Äà>
	put("Q",  "\u2000"); //  en quad space <‚ÄÄ>
	put("R",  "\u202F"); //  narrow no-break space <‚ÄØ>
	put("S",  "\u00A7"); //  section sign <¬ß>
	put("T",  "\u2009"); //  thin space <‚Äâ>
	put("U",  "\u200C"); //  ligature unjoiner <‚Äå>
	put("V",  "\u2E4F"); //  verse divider <‚πè>
	put("W",  "\u2060"); //  word joiner <‚Å†>
	put("X",  "\u203B"); //  reference mark <‚Äª>
	put("Y",  "\u00AD"); //  invisible hyphen <¬≠>
	put("Z",  "\u200B"); //  ZW Space <‚Äã>
	/* 2-Character PRE*/	
	put("~~",  "„Äù"); // U+301D cnd NW hats
	put("!!",  "¬°"); // U+A1 icepicks
	put("((",  "‚∏®"); // U+2E28 double round brackets
	put("+_",  "‚∏ê"); // U+2E10 forked paragraphos
	put("_+",  "‚∏ë"); // U+2E11 forked paragraphos
	put("||",  "‚Äñ"); // U+2016 cnd double bars
	put("[[",  "‚ü¶"); // U+27E6 double square brackets
	put("``",  "ñ∫ò"); // U+16E98 NW boots
	/* Dashes only insert before */
	put("--", 	"‚Äì"); // en dash U+2013
	put("---",	"‚Äî"); // em dash U+2014
	/* legacy tags from BL-SFM or USFM to inquote... not p.sfm */ 
	put("[{", 	"[{"); // insert scripture from reference inside brackets.
	put("[(", 	"[("); // insert variable from reference inside brackets.
	/* not sure why ‚àñcl is needed... it should be ok with typed tags? */
	put("cl", 	"\\cl");
	/* complex (figs Ôπ† feet) tags */
	put("ef", 	"\\ef + \\fr \\ft "); //extended footnote
	put("ex", 	"\\ex + \\xo \\xq \\xt "); //extended footnote
	put("fdc", 	"\\fdc + \\fr \\fk \\ft "); //footnote pointing into deuterocanon.
	put("f", 	"\\f + \\fr \\fk \\ft "); // footnote
	put("fe", 	"\\fe + \\ft "); // endnote
	put("fp", 	"\\fp - \\ft "); // new paragraph in a footnote
	put("fs", 	"\\fs - \\fl "); // new paragraph in a footnote
	put("fig", 	"\\fig (##pt x ##pt) |"); //figure
	put("table",	"\\rem Table |name=\""); //table header
	put("x",	"\\x + \\xo \\xt "); //cross referene
	put("xdc",	"\\xdc + \\xo \\xt "); // reference into Deuterocanon
	put("xnt",	"\\xnt + \\xo \\xt "); // reference into New Testament
	put("xot",	"\\xot + \\xo \\xt "); // reference into Old Testament
}};
Map tagsTemplatePost = new TreeMap() {{
	/* Single Symbol Shifted POST */	
	put("~",  "¬¥"); // U+00B4 cnd NW hats
	put("!",  "‚∏É"); // U+2E03 cnd shell hats
	put("@",  "‚óù"); // U+25DD cnd round hats
	put("#",  "‚∏£"); // U+2E23 cnd square hats
	put("$",  " æ"); // U+02BE cnd bowl hats
	put("%",  "‚∏å"); // U+2E0C slash hats
	put("^",  "ÀÉ"); // U+02C3 cnd angle hats
	put("&",  "");
	put("*",  "");
	put("(",  "‚ù´"); // U+276B cnd round belts
	put(")",  "‚Åç"); // U+204D double bowl belts
	put("_",  "");
	put("+",  "");
	put("{",  "‚¶Ñ"); // U+2984 double curly brackets
	put("}",  "‚ü≠"); // U+27ED double shell brackets
	put("|",  "");
	put(":",  "");
	put("\"",  "‚Äù"); // U+201D double curly hats
	put("<",  "¬ª"); // U+00BB double angle belts
	put(">",  "‚Ä∫"); // U+203A angle belts
	put("?",  "?"); // U+003F curly dots
	/* Single Symbol POST */	
	put("`",  "Àè"); // U+02CF cnd NW boots
	put("1",  "õ≤ê"); // U+BC90 cnd shell boots
	put("2",  "‚óû"); // U+25DE cnd round boots
	put("3",  "‚∏•"); // U+2E25 cnd square boots
	put("4",  "ÍúÜ"); // U+A706 cnd double bars
	put("5",  "‚∏ù"); // U+2E1D slash boots
	put("6",  "À≤"); // U+02F2 angle boots
	put("7",  "");
	put("8",  "");
	put("9",  "‚πç"); // U+2E4D square pilcrows
	put("0",  "‚Åã"); // U+204B curly pilcrows
	put("-",  "");
	put("=",  "");
	put("[",  "Ôπû"); // U+FE5E shell belts
	put("]",  "‚ù≥"); // U+2773 shell brackets
	put("\\",  "");
	put(";",  "");
	put("\'",  "‚Äô"); // U+2019 curly hats
	put(",",  "üô∑"); // U+F677 doublecurly belts
	put(".",  "‚∏¥"); // U+2E34 curly belts
	put("/",  "‚ßµ"); // U+29F5 cnd slash
	/* Single Shifted Alpha POST */	
	put("A",  "");
	put("B",  "");
	put("C",  "");
	put("D",  "");
	put("E",  "");
	put("F",  "");
	put("G",  "");
	put("H",  "");
	put("I",  "");
	put("J",  "");
	put("K",  "");
	put("L",  "");
	put("M",  "");
	put("N",  "");
	put("O",  "");
	put("P",  "");
	put("Q",  "");
	put("R",  "");
	put("S",  "");
	put("T",  "");
	put("U",  "");
	put("V",  "");
	put("W",  "");
	put("X",  "");
	put("Y",  "");
	put("Z",  "");
	/* 2-Character POST*/	
	put("~~",  "„Äû"); // U+301E cnd NW hats
	put("!!",  "!"); // U+0021 icepicks
	put("((",  "‚∏©"); // U+2E29 double round brackets
	put("+_",  "");
	put("_+",  "");
	put("||",  "");
	put("[[",  "‚üß"); // U+27E7 double square brackets
	put("``",  "„Äü"); // U+301F NW boots
	/* Multiple Character POST*/
	put("--", 	"");
	put("---",	"");
	put("[{", 	"}]");
	put("[(", 	")]");
	put("cl", 	"");
	put("fig", 	"|col|||caption text|\\fig*");
	put("ndx", 	"|Index Entry\\ndx*");
	put("table", 	"\"|cols=\"2\"|");
}};


void insertTag()
{
	
	String tag = Macros.input(view, EnterNameTagLabel);
	if( tag == null || tag.length() == 0) return;
	String text = textArea.getSelectedText();
	if(text == null) text = "";
	
	int i;
	String[] tags = tag.split("\\s+");
	int caret = textArea.getCaretPosition();
	StringBuilder buff = new StringBuilder();
	
	for (i=0; i<tags.length; i++) {
		String tpl = tagsTemplate.get(tags[i]);
		if (tpl == null) {
			buff.append('\\').append(tags[i]).append(' ');
			caret += tags[i].length() + 2;
		} 
		else {
			buff.append(tpl);
			caret += tpl.length();
		}
	}
	
	buff.append(text);
	
	for (i=0; i<tags.length; i++) {
		String tpl = tagsTemplatePost.get(tags[i]);
		if (tpl == null) {
			buff.append("\\").append(tags[i]).append('*');
		} 
		else {
			buff.append(tpl);
		}
	}
	
	textArea.setSelectedText(buff.toString());
	
	//if no selected text, put the caret between the tags
	if(text.length() == 0)
		textArea.setCaretPosition(caret);
} 

if(buffer.isReadOnly())
	Macros.error(view, NotEditableMessage);
else
	insertTag();

/*
	Macro index data (in DocBook format)

<listitem>
    <para><filename>AV_Insert_Character_Tags.bsh</filename></para>
    <abstract><para>
        Insert PSFM character tags supplied in an input dialog.
    </para></abstract>
</listitem>

*/

// end PSFM_Insert_Character_Tags.bsh
